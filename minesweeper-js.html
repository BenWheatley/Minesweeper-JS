<!DOCTYPE html>
<html>

<head>
<script>

const width = 3;
const height = 3;
const mineFraction = 0.1;

var flagMode = false;

const State = {
	Unexplored: 'Unexplored',
	Flagged: 'Flagged',
	Open: 'Open'
};

class Cell {
	constructor(mined) {
		this.mined = mined;
		this.state = State.Unexplored;
	}
}

function makeShuffledMinefield() {
	const size = width * height;
	const mineCount = size * mineFraction;
	
	var result = new Array(size);
	
	for (var i=0; i<size; i++) {
		result[i] = new Cell(i < mineCount);
	}
	
	shuffleArray(result);
	
	return result;
}

var minefield = makeShuffledMinefield();

function createGrid() {
	var html = "";
	
	for (var y=0; y<height; y++) {
		for (var x=0; x<width; x++) {
			html += cellHTML(x, y);
		}
		html += "<br />";
	}
	
	document.getElementById('grid').innerHTML = html;
}

function cellID(x, y) {
	return `${x}-${y}`;
}

function indexFor(x, y) {
	return y * width + x;
}

function cellHTML(x, y) {
	return `<button id="${cellID(x, y)}" onclick=\"tapInCell(${x},${y})\">‚¨úÔ∏è</button>`;
}

function tapInCell(x, y) {
	if (flagMode) {
		tryToToggleCellFlag(x, y);
	} else {
		openCell(x, y);
	}
}

function tryToToggleCellFlag(x, y) {
	const index = indexFor(x, y);
	
	if (minefield[index].state == State.Unexplored) {
		minefield[index].state = State.Flagged
	} else if (minefield[index].state == State.Flagged) {
		minefield[index].state = State.Unexplored
	}
	
	const newInnerText = (minefield[index].state == State.Flagged)? "üö©": "‚¨úÔ∏è";
    document.getElementById(cellID(x, y)).innerText = newInnerText;
}

function openCell(x, y) {
	const index = indexFor(x, y);
	const id = cellID(x, y);
	
	var html = "";
	if (minefield[index].mined) {
		html = "üí£";
	} else {
		let bytesPerSymbol = 3;
		html = "0Ô∏è‚É£1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£8Ô∏è‚É£".substr(surroundingMineCount(x, y) * bytesPerSymbol, bytesPerSymbol);
	}
	document.getElementById(id).innerHTML = html;
}

function setFlagMode(newMode) {
	flagMode = newMode;
	const cssOn = "background-color: #FF000088;";
	const cssOff = "background-color: white";
	document.getElementById("flagModeOn").style = flagMode? cssOn : cssOff;
	document.getElementById("flagModeOff").style = flagMode? cssOff : cssOn;
}

function surroundingMineCount(x, y) {
	var count = 0;
	
	for (var ty=y-1; ty<=y+1; ty++) {
		if (ty >= 0 && ty < height) {
			for (var tx=x-1; tx<=x+1; tx++) {
				let inMiddle = (tx == x && ty == y);
				if (tx >= 0 && tx < width && !(inMiddle)) {
					let t_index = ty * width + tx;
					if (minefield[t_index].mined) {
						count++;
					}
				}
			}
		}
	}
	
	return count;
}

function openAll() {
	for (var y=0; y<height; y++) {
		for (var x=0; x<width; x++) {
			tapInCell(x, y);
		}
	}
}

// shuffleArray function ‚Äî https://stackoverflow.com/a/12646864/3632488 ‚Äî CC BY-SA 4.0 ‚Äî StackOverflow users @"Laurens Holst" and @ashleedawg
function shuffleArray(array) {
	for (let i = array.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[array[i], array[j]] = [array[j], array[i]];
	}
}

</script>
</head>

<body onload="createGrid(); setFlagMode(false);">

<h1 style="font-family: Sans-serif;">Emojisweeper</h1>

<div id="grid"></div>

<div style="padding: 1em;">Mode:
<button id="flagModeOn" onclick="setFlagMode(true);">üö©</button>
<button id="flagModeOff" onclick="setFlagMode(false);">üí£</button>
</div>

</body>
</html>
