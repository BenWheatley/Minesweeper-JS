<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8"/>
<style>
.cell {
	width: 30px;
	height: 30px;
	background-color: #DDDDDD;
	display: inline-block;
	border: 1px solid grey;
	text-align: center;
}
</style>
<script>

const width = 5;
const height = 5;
const mineFraction = 0.1;

var flagMode = false;

const State = {
	Unexplored: 'Unexplored',
	Flagged: 'Flagged',
	Open: 'Open'
};

const GameOverState = {
	No: "No",
	Win: "Win",
	Loss: "Loss"
}

class Cell {
	constructor(mined) {
		this.mined = mined;
		this.state = State.Unexplored;
	}
}

class Coordinate {
	constructor(x, y) {
		this.x = x;
		this.y = y;
	}
}

function newGame() {
	createGrid();
	minefield = makeShuffledMinefield();
	document.getElementById("gameOverText").innerText = "";
}

function makeShuffledMinefield() {
	const size = width * height;
	mineCount = Math.floor(size * mineFraction);
	
	var result = new Array(size);
	
	for (var i=0; i<size; i++) {
		result[i] = new Cell(i < mineCount);
	}
	
	shuffleArray(result);
	
	return result;
}

var minefield = makeShuffledMinefield();
var mineCount = 0;

function createGrid() {
	var html = "";
	
	for (var y=0; y<height; y++) {
		for (var x=0; x<width; x++) {
			html += cellHTML(x, y);
		}
		html += "<br />";
	}
	
	document.getElementById('grid').innerHTML = html;
}

function cellID(x, y) {
	return `${x}-${y}`;
}

function indexFor(x, y) {
	return y * width + x;
}

function cellHTML(x, y) {
	return `<span class="cell" id="${cellID(x, y)}" onclick=\"tapInCell(${x},${y})\">‚¨úÔ∏è</span>`;
}

function tapInCell(x, y) {
	if (flagMode) {
		tryToToggleCellFlag(x, y);
	} else {
		openCell(x, y);
	}
}

function tryToToggleCellFlag(x, y) {
	const index = indexFor(x, y);
	
	if (minefield[index].state == State.Open) {
		return;
	}
	
	if (minefield[index].state == State.Unexplored) {
		minefield[index].state = State.Flagged
	} else if (minefield[index].state == State.Flagged) {
		minefield[index].state = State.Unexplored
	}
	
	const newInnerText = (minefield[index].state == State.Flagged)? "üö©": "‚¨úÔ∏è";
	document.getElementById(cellID(x, y)).innerText = newInnerText;
	
	if (countNumberOfUnexploredOrFlaggedSquares() == mineCount) {
		processGameOver(GameOverState.Win);
	}
}

function openCell(x_in, y_in) {
	var queue = [new Coordinate(x_in, y_in)];
	
	var gameOverState = GameOverState.No;
	
	while (queue.length > 0) {
		const currentItem = queue.shift();
		const x = currentItem.x;
		const y = currentItem.y;
		const index = indexFor(currentItem.x, currentItem.y);
		
		if (minefield[index].state != State.Unexplored) {
			continue;
		}
		
		const id = cellID(currentItem.x, currentItem.y);
		
		var html = "";
		if (minefield[index].mined) {
			html = "üí£";
			gameOverState = GameOverState.Loss;
		} else {
			const count = surroundingMineCount(x, y);
			html = textForCount(count);
			if (count == 0) {
				const added = coordinatesOfSurroundingCells(x, y);
				queue = queue.concat(added);
			}
		}
		document.getElementById(id).innerHTML = html;
		minefield[index].state = State.Open;
		
		if (gameOverState != GameOverState.Loss && countNumberOfUnexploredOrFlaggedSquares() == mineCount) {
			gameOverState = GameOverState.Win;
		}
	}
	
	processGameOver(gameOverState);
}

function textForCount(count) {
	const bytesPerSymbol = 3;
	return "0Ô∏è‚É£1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£8Ô∏è‚É£".substr(count * bytesPerSymbol, bytesPerSymbol);
}

function setFlagMode(newMode) {
	flagMode = newMode;
	const cssOn = "background-color: #FF000088;";
	const cssOff = "background-color: white";
	document.getElementById("flagModeOn").style = flagMode? cssOn : cssOff;
	document.getElementById("flagModeOff").style = flagMode? cssOff : cssOn;
}

function coordinatesOfSurroundingCells(x, y) {
	var result = [];
	
	for (var ty=Math.max(y-1, 0); ty<Math.min(y+2, height); ty++) {
		if (ty < height) {
			for (var tx=Math.max(x-1, 0); tx<Math.min(x+2, width); tx++) {
				const inMiddle = ((tx == x) && (ty == y));
				if (tx < width && !(inMiddle)) {
					result.push(new Coordinate(tx, ty));
				}
			}
		}
	}
	
	return result;
}

function surroundingMineCount(x, y) {
	var count = 0;
	
	var coordinates = coordinatesOfSurroundingCells(x, y);
	
	for (var i=0; i<coordinates.length; i++) {
		const c = coordinates[i];
		const t_index = (c.y * width) + c.x;
		if (minefield[t_index].mined) {
			count++;
		}
	}
	
	return count;
}

function openAll() {
	for (var y=0; y<height; y++) {
		for (var x=0; x<width; x++) {
			openCell(x, y);
		}
	}
}

function countNumberOfUnexploredOrFlaggedSquares() {
	var result = 0;
	for (var i=0; i<minefield.length; i++) {
		if (minefield[i].state != State.Open) {
			result++;
		}
	}
	return result;
}

function processGameOver(gameOverState) {
	if (gameOverState == GameOverState.No) { return; }
	openAll();
	document.getElementById("gameOverText").innerText = (gameOverState == GameOverState.Win) ? "Success!" : "You lost!";
}

// shuffleArray function ‚Äî https://stackoverflow.com/a/12646864/3632488 ‚Äî CC BY-SA 4.0 ‚Äî StackOverflow users @"Laurens Holst" and @ashleedawg
function shuffleArray(array) {
	for (let i = array.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[array[i], array[j]] = [array[j], array[i]];
	}
}

</script>
</head>

<body onload="newGame(); setFlagMode(false);">

<h1 style="font-family: Sans-serif;">Emojisweeper</h1>

<h1 id="gameOverText"></h1>

<div id="grid"></div>

<div style="padding: 1em;">Mode:
<button id="flagModeOn" onclick="setFlagMode(true);">üö©</button>
<button id="flagModeOff" onclick="setFlagMode(false);">üí£</button>
</div>

<div style="padding: 1em;">
<button id="flagModeOn" onclick="newGame();">New Game</button>
</div>

</body>
</html>
